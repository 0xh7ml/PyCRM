{% extends 'base.html' %}

{% block title %}{% if stock_in %}Edit Stock In{% else %}New Stock In{% endif %}{% endblock %}

{% block content_header %}{% if stock_in %}Edit Stock In{% else %}New Stock In{% endif %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'stock-in-list' %}">Stock In</a></li>
<li class="breadcrumb-item active">{% if stock_in %}Edit{% else %}Create{% endif %}</li>
{% endblock %}

{% block content %}
<form method="post" id="stock-in-form">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Stock In Items</h3>
                </div>
                <div class="card-body">
                    <!-- Barcode Search -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="barcode-input">Scan/Enter Barcode:</label>
                            <div class="input-group">
                                <input type="text" id="barcode-input" class="form-control" placeholder="Scan or type barcode">
                                <div class="input-group-append">
                                    <button type="button" id="search-barcode" class="btn btn-primary">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">Focus here and scan barcode or type to search</small>
                        </div>
                        <div class="col-md-6">
                            <label for="product-search">Or Search Products:</label>
                            <input type="text" id="product-search" class="form-control" placeholder="Type product name to search">
                            <div id="product-suggestions" class="list-group" style="position: absolute; z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered" id="items-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Barcode</th>
                                    <th>Current Stock</th>
                                    <th>Quantity</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="items-tbody">
                                <!-- Items will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <strong>Total Items: <span id="total-items">0</span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Stock In Details</h3>
                </div>
                <div class="card-body">
                    {% if stock_in %}
                    <div class="form-group">
                        <label>Stock In ID:</label>
                        <p class="form-control-static">{{ stock_in.stock_in_id }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea name="notes" id="notes" class="form-control" rows="4" placeholder="Enter any notes or remarks">{% if stock_in %}{{ stock_in.notes }}{% endif %}</textarea>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-save"></i> 
                            {% if stock_in %}Update Stock In{% else %}Create Stock In{% endif %}
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <a href="{% url 'stock-in-list' %}" class="btn btn-secondary btn-block">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden field for items data -->
    <input type="hidden" name="items_data" id="items-data">
</form>

<!-- Product Data Script -->
<script id="products-data" type="application/json">
{{ products|safe }}
</script>

{% if existing_items %}
<script id="existing-items-data" type="application/json">
{{ existing_items|safe }}
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    let items = [];
    let itemIdCounter = 1;

    // Get products data
    const productsScript = document.getElementById('products-data');
    let products = [];
    
    // Note: We'll get product data via AJAX instead of embedding in template
    
    // Load existing items if editing
    const existingItemsScript = document.getElementById('existing-items-data');
    if (existingItemsScript) {
        try {
            const existingItems = JSON.parse(existingItemsScript.textContent);
            existingItems.forEach(function(item) {
                addItemToTable({
                    id: item.product_id,
                    name: item.product_name,
                    barcode: item.product_barcode,
                    current_stock: 0 // Will be updated by AJAX
                }, item.quantity);
            });
        } catch (e) {
            console.error('Error loading existing items:', e);
        }
    }

    // Barcode input handlers
    const barcodeInput = document.getElementById('barcode-input');
    const searchBarcodeBtn = document.getElementById('search-barcode');
    const productSearchInput = document.getElementById('product-search');
    const productSuggestions = document.getElementById('product-suggestions');

    // Focus barcode input for automatic scanning
    barcodeInput.focus();

    // Search by barcode
    function searchByBarcode(barcode) {
        if (!barcode.trim()) return;

        fetch(`/inventory/search-product-barcode/?barcode=${encodeURIComponent(barcode.trim())}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.product) {
                    addOrUpdateProduct(data.product);
                    barcodeInput.value = '';
                    barcodeInput.focus();
                } else {
                    alert(data.error || 'Product not found');
                    barcodeInput.select();
                }
            })
            .catch(error => {
                console.error('Error searching product:', error);
                alert('Error searching product');
                barcodeInput.select();
            });
    }

    // Barcode input enter key handler
    barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchByBarcode(this.value);
        }
    });

    // Search button handler
    searchBarcodeBtn.addEventListener('click', function() {
        searchByBarcode(barcodeInput.value);
    });

    // Product search with suggestions
    let searchTimeout;
    productSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            productSuggestions.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/inventory/search-products/?q=${encodeURIComponent(query)}&limit=10`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.products) {
                        showProductSuggestions(data.products);
                    }
                })
                .catch(error => {
                    console.error('Error searching products:', error);
                });
        }, 300);
    });

    function showProductSuggestions(products) {
        productSuggestions.innerHTML = '';
        
        if (products.length === 0) {
            productSuggestions.style.display = 'none';
            return;
        }

        products.forEach(product => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `
                <div>
                    <strong>${product.name}</strong><br>
                    <small class="text-muted">Barcode: ${product.barcode} | Stock: ${product.current_stock}</small>
                </div>
            `;
            item.addEventListener('click', function() {
                addOrUpdateProduct(product);
                productSearchInput.value = '';
                productSuggestions.style.display = 'none';
                barcodeInput.focus();
            });
            productSuggestions.appendChild(item);
        });

        productSuggestions.style.display = 'block';
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#product-search') && !e.target.closest('#product-suggestions')) {
            productSuggestions.style.display = 'none';
        }
    });

    function addOrUpdateProduct(product, initialQuantity = 1) {
        // Check if product already exists in the table
        const existingItemIndex = items.findIndex(item => item.product_id === product.id);
        
        if (existingItemIndex !== -1) {
            // Update existing item quantity
            items[existingItemIndex].quantity += initialQuantity;
            updateItemRow(existingItemIndex);
        } else {
            // Add new item
            addItemToTable(product, initialQuantity);
        }
        
        updateTotalItems();
        updateItemsData();
    }

    function addItemToTable(product, quantity = 1) {
        const itemId = itemIdCounter++;
        const item = {
            id: itemId,
            product_id: product.id,
            product_name: product.name,
            barcode: product.barcode,
            current_stock: product.current_stock || 0,
            quantity: quantity
        };
        
        items.push(item);
        
        const tbody = document.getElementById('items-tbody');
        const row = tbody.insertRow();
        row.dataset.itemId = itemId;
        
        row.innerHTML = `
            <td>${product.name}</td>
            <td>${product.barcode}</td>
            <td>${product.current_stock || 0}</td>
            <td>
                <div class="input-group" style="width: 120px;">
                    <div class="input-group-prepend">
                        <button type="button" class="btn btn-sm btn-outline-secondary decrease-qty">-</button>
                    </div>
                    <input type="number" class="form-control form-control-sm quantity-input" value="${quantity}" min="1">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-sm btn-outline-secondary increase-qty">+</button>
                    </div>
                </div>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger remove-item">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        // Add event listeners for the new row
        setupItemRowListeners(row, itemId);
    }

    function setupItemRowListeners(row, itemId) {
        const decreaseBtn = row.querySelector('.decrease-qty');
        const increaseBtn = row.querySelector('.increase-qty');
        const quantityInput = row.querySelector('.quantity-input');
        const removeBtn = row.querySelector('.remove-item');

        decreaseBtn.addEventListener('click', function() {
            const currentQty = parseInt(quantityInput.value);
            if (currentQty > 1) {
                quantityInput.value = currentQty - 1;
                updateItemQuantity(itemId, currentQty - 1);
            }
        });

        increaseBtn.addEventListener('click', function() {
            const currentQty = parseInt(quantityInput.value);
            quantityInput.value = currentQty + 1;
            updateItemQuantity(itemId, currentQty + 1);
        });

        quantityInput.addEventListener('change', function() {
            const newQty = parseInt(this.value) || 1;
            this.value = newQty;
            updateItemQuantity(itemId, newQty);
        });

        removeBtn.addEventListener('click', function() {
            removeItem(itemId);
            row.remove();
        });
    }

    function updateItemQuantity(itemId, newQuantity) {
        const itemIndex = items.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            items[itemIndex].quantity = newQuantity;
            updateTotalItems();
            updateItemsData();
        }
    }

    function updateItemRow(itemIndex) {
        const item = items[itemIndex];
        const row = document.querySelector(`tr[data-item-id="${item.id}"]`);
        if (row) {
            const quantityInput = row.querySelector('.quantity-input');
            quantityInput.value = item.quantity;
        }
    }

    function removeItem(itemId) {
        const itemIndex = items.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            items.splice(itemIndex, 1);
            updateTotalItems();
            updateItemsData();
        }
    }

    function updateTotalItems() {
        const total = items.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('total-items').textContent = total;
    }

    function updateItemsData() {
        const itemsData = items.map(item => ({
            product_id: item.product_id,
            quantity: item.quantity
        }));
        document.getElementById('items-data').value = JSON.stringify(itemsData);
    }

    // Form submission validation
    document.getElementById('stock-in-form').addEventListener('submit', function(e) {
        if (items.length === 0) {
            e.preventDefault();
            alert('Please add at least one product to create stock in.');
            return false;
        }
        updateItemsData();
    });

    // Initial setup
    updateTotalItems();
    updateItemsData();
    
    // Keep barcode input focused
    setInterval(function() {
        if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
            barcodeInput.focus();
        }
    }, 1000);
});
</script>
{% endblock %}